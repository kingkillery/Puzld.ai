# pk-puzldai Handoff Prompt

## Current Status (2026-01-11)

**Adapters Enabled:**
| Adapter | CLI Tool | Status |
|---------|----------|--------|
| Claude | `claude` | ✅ Default |
| Gemini | `gemini` | ✅ Default |
| Codex | `codex` | ✅ Enabled |
| Factory | `droid` | ✅ GLM-4.7, MiniMax-M2.1 |
| Crush | `crush` | ✅ Enabled |

**Build:** v0.2.95, 162 modules bundled

---

## Priority Improvements Needed

### 1. Fix Ralph Loop Agent Selection
**Problem:** Gemini planner sometimes selects unavailable agents (e.g., `codex-safe` when disabled).

**Solution:** Modify `src/cli/commands/ralph.ts` to:
- Query `getAvailableAdapters()` before planning
- Filter plan to only include available agents
- Fall back to `claude` if planned agents unavailable

### 2. Enable Claude Tool Permissions in Ralph
**Problem:** Claude agent generates code but can't write files (permission mode blocks writes).

**Solution:** In `src/adapters/claude.ts`, add a `permissionMode` option:
- Ralph loop should use `--permission-mode default` instead of `--tools ""`
- This allows Claude to attempt writes, which pk-puzldai then approves

### 3. Add Agent Availability Check to Benchmark
**Problem:** Benchmarks fail when adapters aren't available.

**Solution:** Create `scripts/eval/available-agents.ts`:
```typescript
const AVAILABLE = ['claude', 'gemini']; // From getAvailableAdapters()
const TASK_AGENTS = AVAILABLE.filter(a => ['claude','gemini','codex'].includes(a));
```

### 4. Document New Adapter Config
Update `~/.puzldai/config.json`:
```json
{
  "adapters": {
    "factory": { "enabled": true, "model": "GLM-4.7" },
    "crush": { "enabled": true },
    "codex": { "enabled": true }
  }
}
```

---

## Commands to Test

```bash
# Verify all adapters
pk-puzldai check

# Simple task (fastest)
pk-puzldai run "Create a TypeScript interface for User" --agent claude

# Complex task with planning
pk-puzldai ralph "Fix bug in API handler" --iters 2 --scope src

# Multi-agent comparison
pk-puzldai compare "Best error handling approach?"

# Factory with custom model
pk-puzldai run "task" --agent factory --model GLM-4.7
pk-puzldai run "task" --agent factory --model MiniMax-M2.1
```

---

## Files Modified This Session
- `src/lib/config.ts` - Enabled codex, crush; set factory model to GLM-4.7
- `~/.puzldai/config.json` - User config updated
- `BENCHMARK_RESULTS.md` - Updated with optimization notes

---

## Next Agent Tasks

1. **Fix Ralph agent selection** - Filter to available adapters only
2. **Enable Claude file writes** - Add permissionMode option for Ralph
3. **Update check command** - Show which custom models are configured
4. **Add factory model aliases** - `pk-puzldai model set factory GLM-4.7`
5. **Run full benchmark suite** - `bun run scripts/eval/run-ralph-benchmarks.ts`
6. **Update documentation** - AGENTS.md, CLI-ADAPTERS.md

---

## Custom Models Reference
Located in `~/.factory/config.json`:
- **GLM-4.7**: `https://open.z.ai/anthropic` (Z.AI Anthropic endpoint)
- **MiniMax-M2.1**: `https://api.minimax.io/anthropic`
